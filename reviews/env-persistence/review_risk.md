# ⑦ リスクレビュー: 環境変数の永続化手順追記

**レビュー日**: 2026-02-10
**レビュー対象**: README.md, README_ja.md, docs/slack-app-setup.md, docs/architecture.md
**レビュー範囲**: E-03指摘対応（環境変数の永続化手順追記）

---

## 評価サマリー

| 観点 | 評価 | コメント |
|---|---|---|
| セキュリティリスク | ⚠️ 注意 | シェルプロファイルにトークンを平文保存する手法のリスク |
| 操作ミスのリスク | ⚠️ 軽微 | `>>` 追記の重複リスク |
| 代替案の提示 | ⚠️ 不足 | より安全な代替手段（secret manager等）への言及なし |
| 前提検証 | ⭕ 良好 | シェル確認ステップで前提を検証 |
| 盲点 | ⚠️ 注意 | CI/CD環境での環境変数設定への言及なし |

**総合評価: B（概ね妥当だが、セキュリティリスクの明示で改善可能）**

---

## 詳細レビュー

### RK-E01: シェルプロファイルへのトークン平文保存のリスク ⚠️ 中

Setup Guide §5.1 で推奨する方法は「シェルプロファイルにトークンを平文で記述する」ものである。これは最も一般的な方法だが、以下のリスクがある:

1. **ファイルの読み取り**: 同一マシンの他のユーザー・プロセスがプロファイルを読み取り可能
2. **バックアップ経由の漏洩**: Time Machine 等のバックアップにトークンが含まれる
3. **dotfiles の公開**: `.zprofile` を含む dotfiles リポジトリが公開された場合

**現状の対応**:
- `chmod 600` の注意喚起あり ← 1. に対応
- dotfiles リポジトリへの注意喚起あり ← 3. に対応
- バックアップについては未言及 ← 2. は未対応

**評価**: 個人開発者向けのOSSツールとしては、現状の注意喚起で十分。ただし、より安全な代替手段（後述）への言及があるとベター。

### RK-E02: より安全な代替手段への言及なし ⚠️ 低

以下のようなより安全な代替手段が存在するが、Setup Guide では言及されていない:

| 手段 | セキュリティ | 利便性 | 対象ユーザー |
|---|---|---|---|
| `~/.zprofile` に平文記述 | △ | ◎ | 一般ユーザー（現在の推奨） |
| macOS Keychain + `security` コマンド | ○ | △ | セキュリティ重視ユーザー |
| `1password` CLI (`op run`) | ◎ | △ | 1Password ユーザー |
| `direnv` + `.envrc` | ○ | ○ | プロジェクト別設定したいユーザー |

**推奨**: Setup Guide §5.1 の末尾に「より安全な方法」として簡単な言及があると、セキュリティ意識の高いユーザーへの配慮になる。ただし、これはOSS公開後の改善でも十分。

### RK-E03: `>>` 追記による重複行のリスク ⚠️ 低

README のコマンド例:
```bash
echo "export SLACK_BOT_TOKEN='xoxb-your-token-here'" >> ~/.zprofile
```

このコマンドを**複数回実行**すると、`.zprofile` に同じ行が何度も追記される。動作上は問題ないが、プロファイルが汚れる。

**現状の対応**: Setup Guide §5.1 ステップ2で「エディタで直接編集しても OK」と選択肢を提示しており、`>>` コマンドは「追記する方法の一例」として位置づけられている。

**評価**: 重大なリスクではない。ドキュメントで「既にこの行がある場合は追記不要」と一文追加する程度で十分。

### RK-E04: AI エディタでの `${SLACK_BOT_TOKEN}` 展開の前提 ⚠️ 中

README §4 の Cursor 設定:
```json
"SLACK_BOT_TOKEN": "${SLACK_BOT_TOKEN}"
```

この `${SLACK_BOT_TOKEN}` が展開される**タイミングと仕組み**がドキュメント上で明確でない:

1. **Cursor が MCP Server を起動する際**に、`env` フィールドの `${...}` をシェル環境変数から展開する
2. つまり、**Cursor を起動した時点のシェル環境に `SLACK_BOT_TOKEN` が設定されている必要がある**
3. `.zprofile` に追記しても、**Cursor を再起動しないと反映されない**

Setup Guide §5.1 ステップ4の注記で「Cursor を再起動すると反映されます」と書かれているが、**なぜ再起動が必要か**の説明がない。

**推奨**: 「Cursor はプロセス起動時にシェル環境変数を読み込みます。プロファイル変更後は、新しいターミナルを開いてから Cursor を再起動してください」のように、仕組みを1文で補足する。

### RK-E05: トークンのローテーション手順の欠如 ⚠️ 低

Setup Guide §5.1 で環境変数の設定方法は説明されているが、**トークンを変更（ローテーション）する場合の手順**が書かれていない。

ユーザーがトークンをローテーションする場合:
1. Slack API サイトで新しいトークンを取得
2. `.zprofile` の該当行を新しいトークンに書き換え
3. `source ~/.zprofile` で反映
4. Cursor を再起動

この手順は §5.1 の知識で自明に導き出せるため、**独立セクションは不要**。ただし、Security セクションの「トークンが漏洩した場合」に「シェルプロファイルのトークンも更新してください」の一文を追加すると親切。

### RK-E06: Windows における環境変数のスコープ ✅

Setup Guide §5.1 の Windows セクション:
```powershell
[Environment]::SetEnvironmentVariable("SLACK_BOT_TOKEN", "xoxb-your-token-here", "User")
```

`"User"` スコープを使用しているため、管理者権限は不要。これは適切な選択。

### RK-E07: リンク切れのリスク ⚠️ 低

日本語アンカー `#51-方法a-環境変数で設定推奨` を含むリンクが4箇所に存在する:
- README.md L152
- README_ja.md L152
- architecture.md L434
- Setup Guide §5.2, §5.3 の内部参照

これらのリンクは**見出しの変更に脆弱**。見出し「### 5.1 方法A: 環境変数で設定（推奨）」のテキストが変更されると、すべてのリンクが壊れる。

**推奨**: 見出しの変更時は全ファイルのリンクを一括更新する手順を CONTRIBUTING.md に含めると良い。ただし、現時点では問題なし。

---

## 指摘一覧

| ID | 重要度 | 内容 | 対象ファイル |
|---|---|---|---|
| RK-E01 | 低 | トークン平文保存のリスクは現状の対応で十分 | — |
| RK-E02 | 低 | より安全な代替手段への簡単な言及 | docs/slack-app-setup.md |
| RK-E03 | 低 | `>>` 重複追記への注意喚起 | docs/slack-app-setup.md |
| RK-E04 | 中 | Cursor でのenv展開の仕組みとCursor再起動の必要性の補足 | docs/slack-app-setup.md |
| RK-E05 | 低 | トークンローテーション時のプロファイル更新の言及 | docs/slack-app-setup.md |
| RK-E06 | — | Windows のスコープ選択は適切。問題なし | — |
| RK-E07 | 低 | 日本語アンカーリンクの変更耐性 | 全ファイル |
