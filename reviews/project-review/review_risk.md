# レビュー結果: ⑦ リスク（Risk）

**レビュー日**: 2026-02-10
**対象**: slack-fast-mcp プロジェクト全体
**レビュアー軸**: 潜在リスク・代替案・盲点・前提検証

---

## 1. 総合評価

**評価: B+（概ね良好だがセキュリティ面で注意）**

基本的なセキュリティ対策（トークン直書き検出、マスキング関数）は実装されているが、いくつかの潜在的リスクがある。

---

## 2. 指摘事項

### K-01: setup ウィザードでトークンが平文で stdin から読み取られ、stdout に再出力される（重要度: 高）

- **場所**: internal/cli/setup.go L62-65, L104
- **内容**: 
  1. `reader.ReadString('\n')` でトークンを平文で読み取り（エコーバック非制御）
  2. `fmt.Fprintf(out, "  export SLACK_BOT_TOKEN='%s'\n", token)` で再度平文出力
- **影響**: 
  - ターミナルの `history` にトークンが残る可能性
  - スクリーンレコーディングや画面共有時にトークンが露出
  - CI/CD パイプラインのログにトークンが記録される可能性
- **提案**: 
  - `golang.org/x/term` の `ReadPassword()` を使用してエコーバックなしの入力に変更
  - 出力時はマスキングして表示（`xoxb-****...****`）
  - または「クリップボードにコピーして貼り付け」のパターンを案内

### K-02: メッセージ入力のバリデーション不足（重要度: 中）

- **場所**: internal/mcp/tools.go, internal/cli/post.go
- **内容**: メッセージの長さバリデーションがない。Slack API の文字数制限（40,000文字）に任せている
- **影響**: 非常に長いメッセージが Slack API エラーになった際、エラーメッセージが不親切になる
- **提案**: メッセージ長の上限チェック（40,000文字）をツール側で実施し、分かりやすいエラーメッセージを返す

### K-03: Permalink 取得失敗がサイレントに無視される（重要度: 低）

- **場所**: internal/slack/client.go L58, L92-95, L165-169
- **内容**: `GetPermalinkContext` のエラーが `_` で無視されている
- **影響**: パーマリンクが空文字列で返されるが、ユーザーはなぜ空なのか分からない
- **提案**: ベストエフォートの方針は適切だが、debug ログでエラー内容を記録すべき

### K-04: 設定ファイルの権限チェック不足（重要度: 中）

- **場所**: internal/config/config.go
- **内容**: `.slack-mcp.json` やグローバル設定ファイルのファイル権限チェックがない。トークンを直書きした場合、他ユーザーから読み取れる権限（0644）で作成される可能性
- **影響**: 共有サーバー環境でのトークン漏洩リスク
- **提案**: 設定ファイルにトークンが含まれる場合、ファイル権限が 0600/0644 であることを確認し、過度に開いている場合は警告

### K-05: ネットワークエラーのフォールバック分類が広すぎる（重要度: 低）

- **場所**: internal/slack/client.go L251-252
- **内容**: `classifySlackErrorString` の default ケースが全ての未知エラーを `network_error` に分類している
- **影響**: DNS解決エラー、TLS証明書エラー、タイムアウトなど性質の異なるエラーが全て同じメッセージで報告される
- **提案**: 少なくとも `context.DeadlineExceeded` と `context.Canceled` を個別に処理

### K-06: Graceful Shutdown の実装が不完全（重要度: 低）

- **場所**: architecture.md §5.3 vs cmd/slack-fast-mcp/main.go
- **内容**: architecture.md では「進行中の Slack API 呼び出しの完了を待機（最大5秒）」を定義しているが、main.go では `signal.NotifyContext` で context をキャンセルするのみ。待機ロジックは未実装
- **影響**: SIGTERM 受信時にSlack API呼び出し中のリクエストが即座に中断される可能性
- **提案**: `server.NewStdioServer` の ListenContext は context cancel で適切にシャットダウンするため、現状の実装で実用上の問題はない。ただし architecture.md の記述を実態に合わせて修正

### K-07: CI の ubuntu-latest が将来のバージョンアップで動作しなくなるリスク（重要度: 低）

- **場所**: .github/workflows/ci.yml, release.yml
- **内容**: `runs-on: ubuntu-latest` を使用している
- **影響**: ubuntu のメジャーバージョンアップ時にビルドが壊れる可能性
- **提案**: 特にリスクが高いわけではないが、リリースワークフローは `ubuntu-22.04` 等の固定バージョンにする選択肢も

### K-08: go.mod の Go バージョンが 1.25.0（まだ存在しない）（重要度: 高）

- **場所**: go.mod L3
- **内容**: `go 1.25.0` と記載されているが、2026年2月時点で Go 1.25 はまだリリースされていない可能性（Go のリリースサイクルは2月と8月）。go 1.24 が最新安定版の可能性
- **影響**: ユーザーが `go install` で入手できない。CI でのビルドが失敗する可能性
- **提案**: go.mod の Go バージョンを実際にリリースされている最新安定版に修正
