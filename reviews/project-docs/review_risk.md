# レビュー結果: ⑦ リスク（Risk）

**レビュアー**: リスクレビュアー
**対象ドキュメント**: requirements.md / architecture.md / slack-app-setup.md
**レビュー日**: 2026-02-10

---

## 総合評価: B-（いくつかの重大なリスクが未識別）

ドキュメントはレート制限の変更リスクやライブラリのバージョンリスクに一部言及しているが、**セキュリティリスク、運用リスク、外部依存リスク**に関して盲点がある。特にOSS公開を予定しているにもかかわらず、セキュリティ関連の設計が「推奨レベル」に留まっており、強制力が不足している。

---

## 1. 潜在リスクの洗い出し

### 1.1 セキュリティリスク

| # | リスク | 重要度 | 発生確率 | 影響度 | 説明 |
|---|---|---|---|---|---|
| RK-1 | **トークン漏洩リスク** | 🔴 高 | 中 | 高 | `.slack-mcp.json` にトークンを直書き可能な設計。「推奨しない」とは書いてあるが、**技術的に防止していない**。OSS公開後、ユーザーが設定ファイルにトークンを書いてGitにコミットする事故は確実に発生する |
| RK-2 | **Cursor MCP設定でのトークン直書き** | 🔴 高 | 高 | 高 | setup.md §6 および architecture.md §7.3 で `"SLACK_BOT_TOKEN": "xoxb-xxxx-xxxx-xxxx"` とJSON内に直書きしている例を示している。`.cursor/mcp.json` はGitにコミットされる可能性があり、setup.mdの注意書きだけでは不十分 |
| RK-3 | **環境変数経由のトークン露出** | 🟡 中 | 低 | 高 | 環境変数は `/proc/*/environ` や `ps auxe` で他プロセスから読み取り可能（Linux）。共有サーバー環境では追加のリスク。ただし本ツールの想定環境（ローカル開発機）では低リスク |
| RK-4 | **ログへのトークン出力** | 🟡 中 | 中 | 高 | debug ログでAPI リクエスト/レスポンスを出力する方針（requirements.md §8.1）だが、リクエストヘッダにトークンが含まれる。ログのトークンマスキング方針が未定義 |

### 1.2 外部依存リスク

| # | リスク | 重要度 | 発生確率 | 影響度 | 説明 |
|---|---|---|---|---|---|
| RK-5 | **mcp-go の破壊的変更** | 🟡 中 | 中 | 高 | v0.x のため、マイナーバージョンでもAPIが変わる可能性。v0.43.2 時点のAPI（`server.NewMCPServer`, `server.ServeStdio` 等）が将来変更されるリスク |
| RK-6 | **slack-go/slack の破壊的変更** | 🟡 中 | 低 | 中 | v0.17.3。v1未到達だが、更新頻度は低下傾向。メンテナンスが停止するリスクもある |
| RK-7 | **Slack API仕様変更** | 🟡 中 | 中 | 高 | 2025年5月のレート制限変更のように、Slack APIは予告付きで仕様変更される。`conversations.list` の応答形式変更や、新しいチャンネルタイプ追加等のリスク |
| RK-8 | **MCP仕様の進化** | 🟡 中 | 高 | 中 | MCPはAnthropicが推進する比較的新しいプロトコル。仕様が進化・変更される可能性が高い。stdio以外のtransport（HTTP/SSE）が主流になるシナリオも |

### 1.3 運用・展開リスク

| # | リスク | 重要度 | 発生確率 | 影響度 | 説明 |
|---|---|---|---|---|---|
| RK-9 | **チーム展開時の権限問題** | 🟡 中 | 高 | 中 | チームメンバーにSlack App作成権限がない場合（企業のSlackワークスペースでは管理者がApp作成を制限していることが多い）、展開が困難。共有Botトークンの管理問題も発生する |
| RK-10 | **OSS公開後のメンテナンス負荷** | 🟡 中 | 高 | 中 | Issue対応、PR レビュー、セキュリティ脆弱性対応。個人プロジェクトの場合、持続性が懸念 |
| RK-11 | **マルチワークスペース対応の欠如** | 🟢 低 | 中 | 低 | 現設計ではトークン1つ＝ワークスペース1つ。複数ワークスペースを使い分けるユーザーの要望は、OSS公開後に確実に来る |

### 1.4 技術的リスク

| # | リスク | 重要度 | 発生確率 | 影響度 | 説明 |
|---|---|---|---|---|---|
| RK-12 | **チャンネルID判定の誤判定** | 🟡 中 | 中 | 中 | 前述の通り「C始まり = チャンネルID」判定は不完全。`G` 始まりのグループID、`D` 始まりのDM ID を考慮していない。さらに、「C」で始まるチャンネル名（例: `ci-notifications`）は正しくチャンネル名と判定されるか？ → 「C」1文字ではなく、Slack IDの形式（`C` + 英数字10文字程度）で判定すべき |
| RK-13 | **大規模ワークスペースでのパフォーマンス** | 🟢 低 | 低 | 中 | `conversations.list` は全チャンネルを取得する。1000以上のチャンネルがあるワークスペースでは、チャンネル名解決に時間がかかる可能性。ページネーション＋タイムアウトの設計が必要 |
| RK-14 | **MCP Serverの毎回起動オーバーヘッド** | 🟢 低 | 低 | 低 | Go の起動は高速だが、設定ファイル読み込み→トークン検証→（チャンネル名解決の場合API呼び出し）まで含めると、「実行速度最優先」の要件に対して実測値が未確認 |

---

## 2. 前提の検証

ドキュメントが暗黙的に前提としている事項とその妥当性:

| # | 前提 | 記述箇所 | 妥当性 | リスク |
|---|---|---|---|---|
| A-1 | MCP Server は毎回プロセス起動する | requirements.md §2 | ◎ 2026年2月時点のCursorの実装では正しい | Cursorがプロセスを常駐させる仕様に変わった場合、Go選択の優位性が薄れる |
| A-2 | 内部カスタムアプリはレート制限変更の影響を受けない | requirements.md §6.3 | △ 要確認 | Slackの方針変更により影響を受ける可能性。公式ドキュメントのリンクで裏付けが必要 |
| A-3 | ユーザーのローカル開発環境で動作する | 全体 | ◎ | リモート開発環境（Codespaces, Gitpod等）での動作は未考慮 |
| A-4 | 1ワークスペース＝1トークンで十分 | requirements.md §4 | ○ MVP段階では妥当 | チーム展開時に共有トークンの管理問題が顕在化する |
| A-5 | Slack Bot Token（xoxb）のみ対応 | setup.md §3.1 | ○ | User Token（xoxp）が必要なユースケース（ユーザーとしての投稿等）は対象外であることを明記すべき |

---

## 3. 代替案・盲点の指摘

### 3.1 検討されていない代替案

| # | 代替案 | 現在の設計 | トレードオフ |
|---|---|---|---|
| B-1 | **Slack Incoming Webhook の利用** | Bot Token + chat.postMessage | Webhook は投稿のみ可能で履歴取得不可。ただし「投稿だけしたい」ユースケースには圧倒的に簡単（トークン管理不要、スコープ設定不要） |
| B-2 | **既存 Slack MCP Server の fork/拡張** | フルスクラッチ | 既存実装（公式Slack MCP等）をforkして高速化する方が工数は少ない可能性。なぜフルスクラッチか検討されていない |
| B-3 | **設定ファイル形式に YAML/TOML** | JSON | JSONはコメントが書けない。設定ファイルとしてはYAMLやTOMLの方がユーザーフレンドリー。ただし依存追加のトレードオフあり |

### 3.2 見落とされている盲点

| # | 盲点 | 説明 |
|---|---|---|
| BL-1 | **バイナリの自動更新メカニズム** | GitHub Releasesからダウンロード配布だが、バージョンアップの通知・自動更新の仕組みがない。ユーザーは古いバージョンを使い続ける可能性 |
| BL-2 | **コードサイニング** | macOS では Gatekeeper により、署名されていないバイナリは実行時に警告が表示される。OSS公開時にユーザーの信頼を損なうリスク |
| BL-3 | **`/invite @slack-fast-mcp` の動作前提** | setup.md §4.1 で `/invite` コマンドを案内しているが、これはワークスペースの設定によっては無効化されている場合がある |
| BL-4 | **Homebrew / Scoop 等のパッケージマネージャ対応** | 「インストールコストが低い」要件に対し、`curl + chmod` だけでなく、Homebrew tap 等のパッケージマネージャ対応も検討すべき |
| BL-5 | **graceful shutdown の設計不在** | MCP Server が `ServeStdio` で待ち受け中に SIGTERM/SIGINT を受けた場合の終了処理が未定義。進行中のSlack API呼び出しが中断されるリスク |

---

## 4. リスク対応の推奨

### 4.1 即時対応推奨（開発開始前）

| 対応 | 対象リスク | 具体的アクション |
|---|---|---|
| トークン保護の強化 | RK-1, RK-2 | 設定ファイルでのトークン直書きを検出した場合に**エラー終了**（警告ではなく）するオプションの追加。Cursor MCP設定では環境変数の使用方法を最初に案内 |
| ログのトークンマスキング | RK-4 | debug ログ出力時に `xoxb-` で始まる文字列を `xoxb-****` にマスキングするルールを設計に追加 |
| チャンネルID判定の改善 | RK-12 | 正規表現 `^[CGD][A-Z0-9]{8,}$` でSlack ID形式を判定。単純な先頭文字判定は廃止 |

### 4.2 開発中に対応推奨

| 対応 | 対象リスク | 具体的アクション |
|---|---|---|
| レート制限前提の検証 | A-2 | Slack公式ドキュメントのリンクを追記し、前提条件をドキュメントに明記 |
| 依存ライブラリのピン | RK-5, RK-6 | go.mod で特定バージョンにピン。Dependabot/Renovateで更新を管理 |
| graceful shutdown | BL-5 | SIGTERM/SIGINT シグナルハンドリングの設計を追加 |

### 4.3 公開前に対応推奨

| 対応 | 対象リスク | 具体的アクション |
|---|---|---|
| macOS Gatekeeper対応 | BL-2 | GitHub Actions でnotarization、またはREADMEで `xattr -d com.apple.quarantine` の手順を案内 |
| バージョン通知 | BL-1 | `version` コマンドで最新バージョンとの比較を表示する機能を検討 |
| パッケージマネージャ対応 | BL-4 | Homebrew tap の作成を検討 |

---

## 5. 推奨アクション（優先度順）

1. **【高】RK-1, RK-2: トークン保護メカニズムの設計強化** — 直書き検出時のエラー/警告の方針を明確化。ドキュメントの例からトークン直書きサンプルを削除
2. **【高】RK-12: チャンネルID判定ロジックの改善** — 正規表現ベースの堅牢な判定に設計変更
3. **【中】RK-4: ログのトークンマスキング設計** — 機密情報のログ出力防止ルールを追加
4. **【中】A-2: レート制限前提の裏付け** — 公式ドキュメントの参照リンクを追記
5. **【中】BL-5: graceful shutdown の設計追加**
6. **【低】BL-2: macOS Gatekeeper対応の検討**
7. **【低】B-2: フルスクラッチの妥当性記述** — ADR として「なぜ既存実装をforkしないか」を追加
